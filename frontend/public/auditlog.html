<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FavOrg AuditLog-System - Vollbild</title>
    
    <style>
        :root {
            --bg-primary: #1a1f2e;
            --bg-secondary: #252b3b;
            --bg-card: #2d3748;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-primary: #374151;
            --accent-cyan: #06b6d4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .audit-log-container {
            min-height: 100vh;
            background: var(--bg-primary);
            padding: 16px;
            padding-bottom: 80px;
        }

        .audit-log-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-close-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .close-input-btn {
            position: absolute;
            right: 4px;
            background: none;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            transition: all 0.2s;
        }

        .close-input-btn:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .audit-log-content {
            display: flex;
            gap: 16px;
            min-height: calc(100vh - 200px);
        }

        .audit-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            width: 320px;
            flex-shrink: 0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .audit-main {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .audit-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .footer-left, .footer-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary { background: var(--accent-cyan); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); }
        .btn-success { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-info { background: #2563eb; color: white; }
        .btn-small { padding: 4px 8px; font-size: 12px; }

        .category-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--accent-cyan);
            color: white;
            border-color: var(--accent-cyan);
        }

        .test-point {
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .test-point:hover { border-color: var(--accent-cyan); }
        .test-point.status-success { border-color: #059669; }
        .test-point.status-error { border-color: #dc2626; }
        .test-point.status-warning { border-color: #d97706; }
        .test-point.status-info { border-color: #2563eb; }

        .test-point-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .test-point-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-success { background: #059669; color: white; }
        .status-error { background: #dc2626; color: white; }
        .status-warning { background: #d97706; color: white; }
        .status-info { background: #2563eb; color: white; }

        .input {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 8px 32px 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            width: 200px;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .close-btn {
            position: fixed;
            top: 24px;
            right: 16px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1001;
            font-size: 14px;
            font-weight: 500;
        }

        .close-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .flex { display: flex; }
        .align-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .mb-0 { margin-bottom: 0; }
        .mb-16 { margin-bottom: 16px; }
        .text-cyan { color: var(--accent-cyan); }
        .text-secondary { color: var(--text-secondary); }
        .text-sm { font-size: 13px; }

        /* Print Styles f√ºr PDF-Export */
        @media print {
            body { 
                background: white !important; 
                color: black !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .audit-footer, .close-btn { display: none; }
            .test-point { 
                background: white !important; 
                color: black !important; 
                border: 1px solid #ccc !important;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--bg-card);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-cyan);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 8px 8px;
        }

        .config-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
        }

        .form-group textarea {
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="window.close()">‚úï Schlie√üen</button>
    
    <div class="audit-log-container">
        <div class="audit-log-header">
            <div class="flex align-center gap-8">
                <h2 class="mb-0 text-cyan">üîç AuditLog-System - Vollbild</h2>
                <button class="btn btn-secondary" onclick="goBackToFavOrg()" title="Zur√ºck zu FavOrg">
                    üîó FavOrg
                </button>
            </div>
            <div class="header-input-group">
                <div class="input-close-wrapper">
                    <input 
                        type="text" 
                        class="input" 
                        id="newTestInput" 
                        placeholder="Neuer Testname..." 
                        onkeypress="handleInputKeyPress(event)"
                    />
                    <button class="close-input-btn" onclick="clearInput()" title="Input leeren">√ó</button>
                </div>
                <button class="btn btn-primary" onclick="addTest()">‚ûï</button>
                <button class="btn btn-danger" onclick="removeTest()">‚úï</button>
            </div>
        </div>

        <div class="audit-log-content">
            <div class="audit-sidebar">
                <h3 class="mb-16 text-cyan">üìã Test-Bereiche</h3>
                <div id="categoryList">
                    <!-- Wird von JavaScript gef√ºllt -->
                </div>
            </div>

            <div class="audit-main">
                <div class="flex align-center" style="justify-content: space-between; margin-bottom: 16px;">
                    <h3 class="mb-0 text-cyan" id="currentCategoryTitle">üé® Allgemeines Design</h3>
                    <span class="status-badge status-info" id="testCount">4 Tests</span>
                </div>
                <div id="testList">
                    <!-- Wird von JavaScript gef√ºllt -->
                </div>
            </div>
        </div>

        <div class="audit-footer">
            <!-- Links: 5 Status-Filter Buttons -->
            <div class="footer-left">
                <button class="btn btn-primary" onclick="setFilter('')" id="filterAll">Alle (0)</button>
                <button class="btn btn-success" onclick="setFilter('success')" id="filterSuccess">‚úÖ (0)</button>
                <button class="btn btn-danger" onclick="setFilter('error')" id="filterError">‚ùå (0)</button>
                <button class="btn btn-warning" onclick="setFilter('warning')" id="filterWarning">‚è≥ (0)</button>
                <button class="btn btn-info" onclick="setFilter('info')" id="filterInfo">üóëÔ∏è (0)</button>
            </div>
            <!-- Rechts: 5 Aktions-Buttons -->
            <div class="footer-right">
                <button class="btn btn-secondary" onclick="openConfigDialog()">‚öôÔ∏è Config</button>
                <button class="btn btn-secondary" onclick="saveToArchive()">üíæ Test speichern</button>
                <button class="btn btn-secondary" onclick="toggleArchiveView()" id="archiveToggleBtn">üìÅ Archiv (0)</button>
                <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ PDF-Export</button>
                <button class="btn btn-secondary" onclick="resetAll()">üóëÔ∏è Reset</button>
            </div>
        </div>
    </div>

    <!-- Config Dialog -->
    <div id="configDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è AuditLog Konfiguration</h3>
                <span class="close" onclick="closeConfigDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h4>üìã Berichts-Metadaten</h4>
                    <div class="form-group">
                        <label>HauptUser (Tester):</label>
                        <input type="text" id="configTester" value="J√∂rg Renelt" placeholder="Name des Testers">
                    </div>
                    <div class="form-group">
                        <label>Version:</label>
                        <input type="text" id="configVersion" value="v1.2.3" placeholder="z.B. v1.2.3">
                    </div>
                    <div class="form-group">
                        <label>Testumgebung:</label>
                        <input type="text" id="configEnvironment" value="Windows 11, Chrome 117" placeholder="z.B. Windows 11, Chrome 117">
                    </div>
                    <div class="form-group">
                        <label>Testziel:</label>
                        <textarea id="configTestGoal" placeholder="Beschreibung des Testziels">√úberpr√ºfung aller Funktionen und Fehlermeldungen des FavOrg AuditLog-Systems.</textarea>
                    </div>
                    <div class="form-group">
                        <label>Testmethodik:</label>
                        <textarea id="configTestMethodology" placeholder="Beschreibung der Testmethodik">Manueller Funktionstest mit definierten Testf√§llen. Eingaben √ºber Web-Oberfl√§che, Auswertung durch visuelle Pr√ºfung und Funktionsvalidierung.</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveConfigAndClose()">üíæ Speichern</button>
                <button class="btn btn-secondary" onclick="closeConfigDialog()">‚ùå Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        window.currentCategory = 'Allgemeines Design';
        window.testStatuses = {};
        window.testNotes = {};
        window.statusFilter = '';
        window.archivedReports = JSON.parse(localStorage.getItem('favorg-audit-archive') || '[]');
        window.viewMode = 'tests'; // 'tests' oder 'archive'
        
        // Config-Variablen (mit Defaults und LocalStorage-Persistierung)
        window.auditConfig = JSON.parse(localStorage.getItem('favorg-audit-config') || JSON.stringify({
            tester: 'J√∂rg Renelt',
            version: 'v1.2.3',
            environment: 'Windows 11, Chrome 117',
            testGoal: '√úberpr√ºfung aller Funktionen und Fehlermeldungen des FavOrg AuditLog-Systems.',
            testMethodology: 'Manueller Funktionstest mit definierten Testf√§llen. Eingaben √ºber Web-Oberfl√§che, Auswertung durch visuelle Pr√ºfung und Funktionsvalidierung.'
        }));

        // Test-Kategorien
        window.categories = [
            { name: 'Allgemeines Design', icon: 'üé®', count: 4 },
            { name: 'Header-Bereich', icon: 'üîù', count: 4 },
            { name: 'Sidebar-Bereich', icon: 'üìã', count: 5 },
            { name: 'Main-Content', icon: 'üìÑ', count: 4 },
            { name: 'Bookmark-Karten', icon: 'üé¥', count: 6 },
            { name: 'Einstellungen', icon: '‚öôÔ∏è', count: 4 }
        ];

        // Test-Daten
        window.tests = {
            'Allgemeines Design': [
                { name: '80% UI-Kompaktheit', icon: 'üì±', tooltip: '80% kompakte UI-Darstellung pr√ºfen' },
                { name: 'Dark Theme', icon: 'üåô', tooltip: 'Dark Theme Konsistenz testen' },
                { name: 'Responsiveness', icon: 'üìê', tooltip: 'Responsive Layout auf verschiedenen Gr√∂√üen' },
                { name: 'Typographie', icon: 'üî§', tooltip: 'Typographie und Schriftarten pr√ºfen' }
            ],
            'Header-Bereich': [
                { name: 'Logo & Titel Platzierung', icon: 'üè∑Ô∏è', tooltip: 'Logo und Titel korrekt positioniert' },
                { name: 'Navigation Icons', icon: 'üß≠', tooltip: 'Alle Navigation-Icons funktional' },
                { name: 'Bookmark-Anzahl [X]', icon: 'üî¢', tooltip: 'Bookmark-Counter korrekt angezeigt' },
                { name: 'Header-Buttons Layout', icon: 'üîò', tooltip: 'Button-Layout im Header pr√ºfen' }
            ],
            'Sidebar-Bereich': [
                { name: 'Kategorie-Liste', icon: 'üìÇ', tooltip: 'Kategorien korrekt aufgelistet' },
                { name: 'Drag & Drop Kategorien', icon: 'üéØ', tooltip: 'Kategorie D&D funktional' },
                { name: 'Resizing Funktionalit√§t', icon: '‚ÜîÔ∏è', tooltip: 'Sidebar-Gr√∂√üen√§nderung' },
                { name: 'Kategorie-Tooltips', icon: 'üí¨', tooltip: 'Tooltip-Positionierung testen' },
                { name: 'Unterkategorie-Hierarchie', icon: 'üå≥', tooltip: 'Hierarchische Darstellung pr√ºfen' }
            ],
            'Main-Content': [
                { name: 'Bookmark-Darstellung', icon: 'üé¥', tooltip: 'Bookmark-Karten Layout' },
                { name: 'Tabellen-Ansicht Toggle', icon: 'üìã', tooltip: 'List/Grid View umschalten' },
                { name: 'Scroll-Performance', icon: 'üìú', tooltip: 'Scrolling bei vielen Bookmarks' },
                { name: 'Leere-State Anzeige', icon: 'üì≠', tooltip: 'Anzeige wenn keine Bookmarks' }
            ],
            'Bookmark-Karten': [
                { name: 'Status-Farb-System', icon: 'üé®', tooltip: 'Farben f√ºr verschiedene Status' },
                { name: 'Lock/Unlock Buttons', icon: 'üîí', tooltip: 'Sperr-Funktionalit√§t testen' },
                { name: 'Action-Buttons Layout', icon: 'üîò', tooltip: 'Edit/Delete/Link Button-Layout' },
                { name: 'Drag-Handles sichtbar', icon: '‚ãÆ‚ãÆ', tooltip: 'Drag-Griffe erkennbar' },
                { name: 'Hover-States', icon: 'üëÜ', tooltip: 'Hover-Effekte auf Karten' },
                { name: 'Status-Badge Position', icon: 'üè∑Ô∏è', tooltip: 'Status-Badges korrekt positioniert' }
            ],
            'Einstellungen': [
                { name: 'Tab-Navigation Icons', icon: 'üóÇÔ∏è', tooltip: 'Settings-Tabs mit Icons' },
                { name: 'Theme-Einstellungen', icon: 'üåô', tooltip: 'Dark/Light Theme Toggle' },
                { name: 'Meldungen Delay Checkbox', icon: '‚è∞', tooltip: 'Toast-Delay Einstellung' },
                { name: 'Gefahr-Bereich rot', icon: '‚ö†Ô∏è', tooltip: 'Danger-Zone rote Markierung' }
            ]
        };

        // Render-Funktionen
        function renderCategories() {
            console.log('üé® renderCategories() aufgerufen');
            const container = document.getElementById('categoryList');
            if (!container) return;
            
            container.innerHTML = '';
            
            window.categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn ' + (category.name === window.currentCategory ? 'active' : '');
                btn.onclick = function() { selectCategory(category.name); };
                
                btn.innerHTML = '<span>' + category.icon + '</span>' +
                               '<span style="flex: 1;">' + category.name + '</span>' +
                               '<span class="status-badge status-info">' + category.count + '</span>';
                
                container.appendChild(btn);
            });
        }

        function renderTests() {
            console.log('üß™ renderTests() aufgerufen');
            const container = document.getElementById('testList');
            if (!container) return;
            
            const tests = window.tests[window.currentCategory] || [];
            let filteredTests = tests;
            
            if (window.statusFilter) {
                filteredTests = tests.filter(test => window.testStatuses[test.name] === window.statusFilter);
            }
            
            container.innerHTML = '';
            document.getElementById('testCount').textContent = filteredTests.length + ' Tests';

            if (filteredTests.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">' +
                                    '<p>Keine Tests f√ºr "' + window.currentCategory + '" gefunden.</p>' +
                                    '</div>';
                return;
            }

            filteredTests.forEach(function(test) {
                const testStatus = window.testStatuses[test.name];
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-point ' + (testStatus ? 'status-' + testStatus : '');
                
                let statusBadgeHtml = '';
                if (testStatus) {
                    const statusConfig = {
                        'success': { icon: '‚úÖ', text: 'Bestanden' },
                        'error': { icon: '‚ùå', text: 'Fehlgeschlagen' },
                        'warning': { icon: '‚è≥', text: 'In Bearbeitung' },
                        'info': { icon: 'üóëÔ∏è', text: '√úbersprungen' }
                    };
                    const config = statusConfig[testStatus];
                    if (config) {
                        statusBadgeHtml = '<span class="status-badge status-' + testStatus + '">' + config.icon + ' ' + config.text + '</span>';
                    }
                }

                testDiv.innerHTML = 
                    '<div class="test-point-header">' +
                        '<div class="flex align-center gap-8">' +
                            '<span style="font-size: 16px;">' + test.icon + '</span>' +
                            '<div style="flex: 1;"><strong>' + test.name + '</strong></div>' +
                        '</div>' +
                        statusBadgeHtml +
                    '</div>' +
                    '<p class="text-secondary text-sm" style="margin: 4px 0 8px 0;">' + test.tooltip + '</p>' +
                    '<div class="test-point-actions">' +
                        '<button class="btn btn-success btn-small" onclick="setTestStatus(\'' + test.name + '\', \'success\')" title="Test bestanden">‚úÖ</button>' +
                        '<button class="btn btn-danger btn-small" onclick="setTestStatus(\'' + test.name + '\', \'error\')" title="Test fehlgeschlagen">‚ùå</button>' +
                        '<button class="btn btn-warning btn-small" onclick="setTestStatus(\'' + test.name + '\', \'warning\')" title="Test in Bearbeitung">‚è≥</button>' +
                        '<button class="btn btn-info btn-small" onclick="setTestStatus(\'' + test.name + '\', \'info\')" title="Test √ºbersprungen">üóëÔ∏è</button>' +
                    '</div>';
                
                container.appendChild(testDiv);
            });
        }

        // Event-Handler
        function selectCategory(categoryName) {
            window.currentCategory = categoryName;
            const category = window.categories.find(function(cat) { return cat.name === categoryName; });
            if (category) {
                document.getElementById('currentCategoryTitle').textContent = category.icon + ' ' + categoryName;
            }
            renderCategories();
            renderTests();
        }

        function setTestStatus(testName, status) {
            window.testStatuses[testName] = status;
            renderTests();
            updateStatusCounts();
        }

        function updateStatusCounts() {
            const allStatuses = Object.values(window.testStatuses);
            const counts = {
                all: allStatuses.length,
                success: allStatuses.filter(function(s) { return s === 'success'; }).length,
                error: allStatuses.filter(function(s) { return s === 'error'; }).length,
                warning: allStatuses.filter(function(s) { return s === 'warning'; }).length,
                info: allStatuses.filter(function(s) { return s === 'info'; }).length
            };

            document.getElementById('filterAll').textContent = 'Alle (' + counts.all + ')';
            document.getElementById('filterSuccess').textContent = '‚úÖ (' + counts.success + ')';
            document.getElementById('filterError').textContent = '‚ùå (' + counts.error + ')';
            document.getElementById('filterWarning').textContent = '‚è≥ (' + counts.warning + ')';
            document.getElementById('filterInfo').textContent = 'üóëÔ∏è (' + counts.info + ')';
        }

        function updateArchiveCount() {
            const btn = document.getElementById('archiveToggleBtn');
            if (window.viewMode === 'archive') {
                btn.textContent = 'üìã Testpunkte';
                btn.title = 'Zur√ºck zu Testpunkten';
            } else {
                btn.textContent = 'üìÅ Archiv (' + window.archivedReports.length + ')';
                btn.title = 'Archiv anzeigen';
            }
        }

        function toggleArchiveView() {
            if (window.viewMode === 'archive') {
                // Zur√ºck zu Tests
                window.viewMode = 'tests';
                renderCategories();
                renderTests();
            } else {
                // Zu Archiv wechseln
                window.viewMode = 'archive';
                renderArchiveView();
            }
            updateArchiveCount();
        }

        function renderArchiveView() {
            const categoryContainer = document.getElementById('categoryList');
            const testContainer = document.getElementById('testList');
            
            // Sidebar f√ºr Archiv
            categoryContainer.innerHTML = '<h4 class="text-cyan mb-16">üìÅ Gespeicherte Berichte</h4>';
            
            // Main-Bereich f√ºr Archiv
            if (window.archivedReports.length === 0) {
                testContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 18px; margin-bottom: 16px;">üìÅ Keine archivierten Berichte vorhanden</p>
                        <p>Speichern Sie Tests mit dem "üíæ Test speichern" Button, um Berichte zu erstellen.</p>
                    </div>
                `;
            } else {
                let archiveHtml = '';
                window.archivedReports.forEach((report, index) => {
                    archiveHtml += `
                        <div class="test-point" style="border-color: var(--accent-cyan);">
                            <div class="test-point-header">
                                <div class="flex align-center gap-8">
                                    <span style="font-size: 16px;">üìä</span>
                                    <div style="flex: 1;">
                                        <strong>${report.category}</strong>
                                        <div class="text-secondary text-sm">${report.timestamp}</div>
                                    </div>
                                </div>
                                <span class="status-badge status-info">${report.completedTests}/${report.totalTests} Tests</span>
                            </div>
                            <p class="text-secondary text-sm" style="margin: 4px 0 8px 0;">
                                Bericht erstellt am ${report.timestamp} mit ${report.completedTests} abgeschlossenen Tests
                            </p>
                            <div class="test-point-actions">
                                <button class="btn btn-info btn-small" onclick="viewReport(${index})" title="Bericht anzeigen">üëÅÔ∏è Anzeigen</button>
                                <button class="btn btn-primary btn-small" onclick="loadReport(${index})" title="Bericht laden">üì• Laden</button>
                                <button class="btn btn-danger btn-small" onclick="deleteReport(${index})" title="Bericht l√∂schen">üóëÔ∏è L√∂schen</button>
                            </div>
                        </div>
                    `;
                });
                testContainer.innerHTML = archiveHtml;
            }
            
            document.getElementById('testCount').textContent = window.archivedReports.length + ' Berichte';
            document.getElementById('currentCategoryTitle').textContent = 'üìÅ Archivierte Test-Berichte';
        }

        function loadReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            // Lade gespeicherte Test-Status
            window.testStatuses = {...report.testStatuses};
            window.testNotes = {...report.testNotes};
            window.currentCategory = report.category;
            
            // Zur√ºck zur Test-Ansicht
            window.viewMode = 'tests';
            renderCategories();
            renderTests();
            updateStatusCounts();
            updateArchiveCount();
            
            alert(`Bericht "${report.category}" vom ${report.timestamp} wurde geladen`);
        }

        function deleteReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            if (confirm(`Bericht "${report.category}" vom ${report.timestamp} l√∂schen?`)) {
                window.archivedReports.splice(index, 1);
                localStorage.setItem('favorg-audit-archive', JSON.stringify(window.archivedReports));
                renderArchiveView();
                updateArchiveCount();
                alert('Bericht gel√∂scht');
            }
        }

        function viewReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            // Rekonstruiere die Tests aus dem gespeicherten Bericht
            const savedTests = Object.keys(report.testStatuses).map(testName => ({
                name: testName,
                icon: 'üìã', // Default Icon
                tooltip: report.testNotes[testName] || 'Test aus Archiv',
                category: report.category,
                categoryIcon: getCategoryIcon(report.category)
            }));
            
            const testResults = calculateTestResults(savedTests, report.testStatuses, report.testNotes);
            
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(generateStructuredReport(savedTests, testResults, report.timestamp, report.category, report.testStatuses, report.testNotes));
            printWindow.document.close();
            
            console.log(`Bericht "${report.category}" wird angezeigt`);
        }

        function setFilter(filter) {
            window.statusFilter = filter;
            renderTests();
        }

        // Input-Handler
        function handleInputKeyPress(event) {
            if (event.key === 'Enter') {
                addTest();
            }
        }

        function clearInput() {
            document.getElementById('newTestInput').value = '';
        }

        function addTest() {
            const input = document.getElementById('newTestInput');
            const testName = input.value.trim();
            
            if (!testName) {
                alert('Bitte geben Sie einen Testnamen ein');
                return;
            }
            
            if (!window.tests[window.currentCategory]) {
                window.tests[window.currentCategory] = [];
            }
            
            window.tests[window.currentCategory].push({
                name: testName,
                icon: 'üîç',
                tooltip: 'Benutzerdefinierter Test'
            });
            
            input.value = '';
            renderTests();
        }

        function removeTest() {
            const input = document.getElementById('newTestInput');
            const testName = input.value.trim();
            
            if (!testName) {
                alert('Bitte geben Sie den Namen des zu l√∂schenden Tests ein');
                return;
            }
            
            const tests = window.tests[window.currentCategory] || [];
            const newTests = tests.filter(function(test) { return test.name !== testName; });
            
            if (newTests.length === tests.length) {
                alert('Test "' + testName + '" nicht gefunden');
                return;
            }
            
            window.tests[window.currentCategory] = newTests;
            delete window.testStatuses[testName];
            
            input.value = '';
            renderTests();
        }

        // Archiv-Funktionen
        function saveToArchive() {
            const tests = window.tests[window.currentCategory] || [];
            const completedTests = tests.filter(test => window.testStatuses[test.name]);
            
            if (completedTests.length === 0) {
                alert('Keine Tests mit Status zum Speichern gefunden');
                return;
            }
            
            const report = {
                id: Date.now(),
                category: window.currentCategory,
                timestamp: new Date().toLocaleString('de-DE'),
                totalTests: tests.length,
                completedTests: completedTests.length,
                testStatuses: {...window.testStatuses},
                testNotes: {...window.testNotes}
            };
            
            window.archivedReports.unshift(report);
            
            // Nur die letzten 10 Berichte behalten
            if (window.archivedReports.length > 10) {
                window.archivedReports = window.archivedReports.slice(0, 10);
            }
            
            localStorage.setItem('favorg-audit-archive', JSON.stringify(window.archivedReports));
            updateArchiveCount();
            
            alert('Test-Stand f√ºr "' + window.currentCategory + '" ins Archiv gespeichert (' + completedTests.length + ' Tests)');
        }



        // Alle Tests aller Kategorien sammeln (f√ºr vollst√§ndigen PDF-Export)
        function getAllTests() {
            let allTests = [];
            const categories = Object.keys(window.tests);
            
            categories.forEach(category => {
                const categoryTests = window.tests[category] || [];
                const testsWithCategory = categoryTests.map(test => ({
                    ...test,
                    category: category,
                    categoryIcon: getCategoryIcon(category)
                }));
                allTests = [...allTests, ...testsWithCategory];
            });
            
            return allTests;
        }

        function getCategoryIcon(category) {
            const icons = {
                'Allgemeines Design': 'üé®',
                'Header-Bereich': 'üîù',
                'Sidebar-Bereich': 'üìã',
                'Main-Content': 'üìÑ',
                'Bookmark-Karten': 'üé¥',
                'Einstellungen': '‚öôÔ∏è'
            };
            return icons[category] || 'üìÇ';
        }

        // Erweiterte PDF-Export Funktion mit strukturiertem Bericht
        function exportToPDF() {
            const tests = getAllTests(); // Verwende ALLE Tests statt nur aktuelle Kategorie
            const testResults = calculateTestResults(tests);
            const currentDate = new Date().toLocaleString('de-DE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(generateStructuredReport(tests, testResults, currentDate, 'Alle Bereiche'));
            printWindow.document.close();
        }

        // Hilfsfunktion zur Berechnung der Testergebnisse
        function calculateTestResults(tests) {
            let total = tests.length;
            let passed = 0;
            let failed = 0;
            let warning = 0;
            let ungepr√ºft = 0;
            let issues = [];
            
            tests.forEach(test => {
                const status = window.testStatuses[test.name] || 'ungepr√ºft';
                switch(status) {
                    case 'success':
                        passed++;
                        break;
                    case 'error':
                        failed++;
                        issues.push({
                            name: test.name,
                            type: 'FEHLER',
                            description: window.testNotes[test.name] || 'Kritischer Fehler festgestellt'
                        });
                        break;
                    case 'warning':
                        warning++;
                        issues.push({
                            name: test.name,
                            type: 'WARNUNG',
                            description: window.testNotes[test.name] || 'Verbesserung empfohlen'
                        });
                        break;
                    default:
                        ungepr√ºft++;
                }
            });
            
            return { total, passed, failed, warning, ungepr√ºft, issues };
        }

        // Hilfsfunktion zur Generierung des strukturierten Berichts
        function generateStructuredReport(tests, results, currentDate) {
            return `
                <!DOCTYPE html>
                <html lang="de">
                <head>
                    <meta charset="UTF-8">
                    <title>Testbericht ¬∑ FavOrg</title>
                    <style>
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 30px; 
                            background: white !important;
                            color: #333 !important;
                            line-height: 1.5;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .report-header { 
                            text-align: center; 
                            border-bottom: 3px solid #06b6d4; 
                            padding-bottom: 25px; 
                            margin-bottom: 40px;
                            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                            padding: 30px;
                            border-radius: 8px;
                        }
                        .report-header h1 {
                            color: #1a365d !important;
                            font-size: 32px;
                            margin-bottom: 10px;
                            font-weight: 700;
                        }
                        .metadata-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 30px;
                            background: #f8fafc;
                            padding: 20px;
                            border-radius: 6px;
                            border-left: 4px solid #06b6d4;
                        }
                        .metadata-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #e2e8f0;
                        }
                        .metadata-label {
                            font-weight: 600;
                            color: #374151;
                        }
                        .metadata-value {
                            color: #1f2937;
                            font-weight: 500;
                        }
                        .section {
                            margin-bottom: 35px;
                            padding: 20px;
                            border-radius: 6px;
                            border: 1px solid #e5e7eb;
                        }
                        .section h2 {
                            color: #06b6d4 !important;
                            font-size: 20px;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 2px solid #06b6d4;
                        }
                        .test-case {
                            padding: 15px;
                            margin-bottom: 12px;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            background: white;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        }
                        .test-case.success { border-color: #10b981; background: #f0fdf4; }
                        .test-case.error { border-color: #ef4444; background: #fef2f2; }
                        .test-case.warning { border-color: #f59e0b; background: #fffbeb; }
                        .test-case.ungepr√ºft { border-color: #6b7280; background: #f9fafb; }
                        .test-info {
                            flex: 1;
                        }
                        .test-name {
                            font-weight: 600;
                            font-size: 16px;
                            margin-bottom: 5px;
                        }
                        .test-description {
                            color: #6b7280;
                            font-size: 14px;
                            margin-bottom: 8px;
                        }
                        .test-notes {
                            font-style: italic;
                            color: #4b5563;
                            font-size: 13px;
                        }
                        .status-badge {
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-weight: 600;
                            font-size: 14px;
                            text-align: center;
                            min-width: 80px;
                        }
                        .status-success { background: #10b981; color: white; }
                        .status-error { background: #ef4444; color: white; }
                        .status-warning { background: #f59e0b; color: white; }
                        .status-ungepr√ºft { background: #6b7280; color: white; }
                        .results-summary {
                            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                            color: white !important;
                            padding: 25px;
                            border-radius: 8px;
                            margin-bottom: 25px;
                        }
                        .results-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                            gap: 15px;
                            margin-top: 15px;
                        }
                        .result-item {
                            text-align: center;
                            background: rgba(255,255,255,0.1);
                            padding: 15px;
                            border-radius: 6px;
                        }
                        .result-number {
                            font-size: 28px;
                            font-weight: bold;
                            display: block;
                        }
                        .result-label {
                            font-size: 12px;
                            opacity: 0.9;
                        }
                        .issues-list {
                            list-style: none;
                            padding: 0;
                        }
                        .issue-item {
                            background: #fef2f2;
                            border-left: 4px solid #ef4444;
                            padding: 15px;
                            margin-bottom: 10px;
                            border-radius: 0 6px 6px 0;
                        }
                        .issue-type {
                            font-weight: 700;
                            color: #dc2626;
                            font-size: 14px;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 12px 20px;
                            background: #06b6d4;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        }
                        @media print {
                            body { background: white !important; color: #333 !important; }
                            .print-btn { display: none; }
                            .section { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">üìÑ Bericht drucken</button>
                    
                    <div class="report-header">
                        <h1>üìã Testbericht ¬∑ FavOrg</h1>
                        <p style="font-size: 18px; color: #64748b; margin: 0;">AuditLog-System Qualit√§tspr√ºfung</p>
                    </div>

                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <span class="metadata-label">üìÖ Datum:</span>
                            <span class="metadata-value">${currentDate}</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">üë§ Tester:</span>
                            <span class="metadata-value">${window.auditConfig.tester}</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">üè∑Ô∏è Version:</span>
                            <span class="metadata-value">${window.auditConfig.version}</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">üíª Testumgebung:</span>
                            <span class="metadata-value">${window.auditConfig.environment}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>üéØ Ziel des Tests</h2>
                        <p>${window.auditConfig.testGoal}</p>
                    </div>

                    <div class="section">
                        <h2>üìã Testobjekt</h2>
                        <p><strong>Testbereich:</strong> ${window.currentCategory}</p>
                        <p>Testpunkte werden systematisch auf Funktionalit√§t, Design-Konsistenz und Benutzerfreundlichkeit √ºberpr√ºft.</p>
                    </div>

                    <div class="section">
                        <h2>üî¨ Testmethodik</h2>
                        <p>${window.auditConfig.testMethodology}</p>
                    </div>

                    <div class="results-summary">
                        <h2 style="margin-top: 0; color: white;">üìä Testergebnisse</h2>
                        <p style="color: rgba(255,255,255,0.9);">
                            ${results.passed} von ${results.total} Testf√§llen bestanden.
                            ${results.failed > 0 ? ' Es wurden ' + results.failed + ' kritische Fehler festgestellt.' : ' Alle kritischen Tests erfolgreich.'}
                        </p>
                        <div class="results-grid">
                            <div class="result-item">
                                <span class="result-number">${results.total}</span>
                                <span class="result-label">Gesamt</span>
                            </div>
                            <div class="result-item">
                                <span class="result-number">${results.passed}</span>
                                <span class="result-label">‚úÖ Bestanden</span>
                            </div>
                            <div class="result-item">
                                <span class="result-number">${results.failed}</span>
                                <span class="result-label">‚ùå Fehler</span>
                            </div>
                            <div class="result-item">
                                <span class="result-number">${results.warning}</span>
                                <span class="result-label">‚ö†Ô∏è Warnung</span>
                            </div>
                            <div class="result-item">
                                <span class="result-number">${results.ungepr√ºft}</span>
                                <span class="result-label">‚è≥ Ungepr√ºft</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>üß™ Testf√§lle</h2>
                        ${tests.map((test, index) => {
                            const status = window.testStatuses[test.name] || 'ungepr√ºft';
                            const notes = window.testNotes[test.name];
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(status) {
                                case 'success':
                                    statusText = 'OK';
                                    statusClass = 'success';
                                    break;
                                case 'error':
                                    statusText = 'FEHLER';
                                    statusClass = 'error';
                                    break;
                                case 'warning':
                                    statusText = 'WARNUNG';
                                    statusClass = 'warning';
                                    break;
                                default:
                                    statusText = 'UNGEPR√úFT';
                                    statusClass = 'ungepr√ºft';
                            }
                            
                            return `
                                <div class="test-case ${statusClass}">
                                    <div class="test-info">
                                        <div class="test-name">${index + 1}. ${test.icon} ${test.name}</div>
                                        <div class="test-description">${test.tooltip}</div>
                                        ${notes ? `<div class="test-notes">üí≠ Notiz: ${notes}</div>` : ''}
                                    </div>
                                    <div class="status-badge status-${statusClass}">[${statusText}]</div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    ${results.issues.length > 0 ? `
                        <div class="section">
                            <h2>‚ö†Ô∏è Abweichungen und Probleme</h2>
                            <ul class="issues-list">
                                ${results.issues.map(issue => `
                                    <li class="issue-item">
                                        <div class="issue-type">${issue.type}: ${issue.name}</div>
                                        <p>${issue.description}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="section">
                        <h2>üí° Fazit und Empfehlungen</h2>
                        <p>
                            ${results.failed === 0 ? 
                                `Das ${window.currentCategory} System ist vollst√§ndig funktionsf√§hig. Alle ${results.passed} kritischen Tests wurden erfolgreich bestanden.` :
                                `Das ${window.currentCategory} System weist ${results.failed} kritische Fehler auf. Vor der Freigabe m√ºssen diese Probleme behoben und erneut getestet werden.`
                            }
                        </p>
                        ${results.warning > 0 ? `<p><strong>Empfehlung:</strong> ${results.warning} Verbesserungen sollten f√ºr eine optimale Benutzererfahrung umgesetzt werden.</p>` : ''}
                    </div>

                    <div class="section">
                        <h2>üìé Anhang</h2>
                        <p>Detaillierte Testdaten und Screenshots sind im internen AuditLog-System archiviert.</p>
                        <p><strong>Berichts-ID:</strong> AuditLog-${Date.now()}</p>
                        <p><strong>Generiert von:</strong> FavOrg AuditLog-System v${window.auditConfig.version}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function resetAll() {
            if (confirm('Alle Tests zur√ºcksetzen?')) {
                window.testStatuses = {};
                window.testNotes = {};
                renderTests();
                updateStatusCounts();
            }
        }

        function goBackToFavOrg() {
            if (window.opener) {
                window.opener.focus();
                window.close();
            } else {
                window.location.href = '/';
            }
        }

        // Config-Dialog Funktionen
        function openConfigDialog() {
            // Lade aktuelle Config in die Formularfelder
            document.getElementById('configTester').value = window.auditConfig.tester;
            document.getElementById('configVersion').value = window.auditConfig.version;
            document.getElementById('configEnvironment').value = window.auditConfig.environment;
            document.getElementById('configTestGoal').value = window.auditConfig.testGoal;
            document.getElementById('configTestMethodology').value = window.auditConfig.testMethodology;
            
            document.getElementById('configDialog').style.display = 'block';
        }

        function closeConfigDialog() {
            document.getElementById('configDialog').style.display = 'none';
        }

        function saveConfigAndClose() {
            // Speichere die Config-Werte
            window.auditConfig.tester = document.getElementById('configTester').value;
            window.auditConfig.version = document.getElementById('configVersion').value;
            window.auditConfig.environment = document.getElementById('configEnvironment').value;
            window.auditConfig.testGoal = document.getElementById('configTestGoal').value;
            window.auditConfig.testMethodology = document.getElementById('configTestMethodology').value;
            
            // Persistiere in LocalStorage
            localStorage.setItem('favorg-audit-config', JSON.stringify(window.auditConfig));
            
            closeConfigDialog();
            alert('Konfiguration erfolgreich gespeichert!');
        }

        // Funktion zum Automatischen Erfassen der Browser-Umgebung
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            let os = 'Unknown OS';
            let browser = 'Unknown Browser';
            
            // Betriebssystem erkennen
            if (userAgent.indexOf('Windows NT 10.0') !== -1) os = 'Windows 10/11';
            else if (userAgent.indexOf('Windows NT 6.3') !== -1) os = 'Windows 8.1';
            else if (userAgent.indexOf('Windows NT 6.1') !== -1) os = 'Windows 7';
            else if (userAgent.indexOf('Mac') !== -1) os = 'macOS';
            else if (userAgent.indexOf('Linux') !== -1) os = 'Linux';
            
            // Browser erkennen
            if (userAgent.indexOf('Chrome') !== -1 && userAgent.indexOf('Edge') === -1) {
                const chromeMatch = userAgent.match(/Chrome\/(\d+)/);
                browser = 'Chrome ' + (chromeMatch ? chromeMatch[1] : '');
            } else if (userAgent.indexOf('Firefox') !== -1) {
                const firefoxMatch = userAgent.match(/Firefox\/(\d+)/);
                browser = 'Firefox ' + (firefoxMatch ? firefoxMatch[1] : '');
            } else if (userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1) {
                browser = 'Safari';
            } else if (userAgent.indexOf('Edge') !== -1) {
                const edgeMatch = userAgent.match(/Edge\/(\d+)/);
                browser = 'Edge ' + (edgeMatch ? edgeMatch[1] : '');
            }
            
            return os + ', ' + browser;
        }

        // Initialisierung
        function initAuditLog() {
            console.log('üöÄ AuditLog Initialisierung gestartet');
            
            try {
                // Auto-Update der Testumgebung bei erstmaliger Nutzung
                if (!localStorage.getItem('favorg-audit-config')) {
                    window.auditConfig.environment = detectEnvironment();
                    localStorage.setItem('favorg-audit-config', JSON.stringify(window.auditConfig));
                }
                
                renderCategories();
                renderTests();
                updateStatusCounts();
                updateArchiveCount();
                console.log('üéâ AuditLog erfolgreich initialisiert');
            } catch (error) {
                console.error('‚ùå Initialisierungs-Fehler:', error);
            }
        }

        // Mehrfache Initialisierungs-Strategien
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuditLog);
        } else {
            initAuditLog();
        }

        setTimeout(initAuditLog, 500);
        
        console.log('üìù AuditLog Script vollst√§ndig geladen');
    </script>
</body>
</html>