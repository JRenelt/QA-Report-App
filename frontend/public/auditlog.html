<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FavOrg AuditLog-System - Vollbild</title>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root {
            --bg-primary: #1a1f2e;
            --bg-secondary: #252b3b;
            --bg-card: #2d3748;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-primary: #374151;
            --accent-cyan: #06b6d4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .audit-log-container {
            min-height: 100vh;
            background: var(--bg-primary);
            padding: 16px;
            padding-bottom: 80px;
        }

        .audit-log-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-close-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .close-input-btn {
            position: absolute;
            right: 4px;
            background: none;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            transition: all 0.2s;
        }

        .close-input-btn:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .audit-log-content {
            display: flex;
            gap: 16px;
            min-height: calc(100vh - 200px);
        }

        .audit-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            width: 320px;
            flex-shrink: 0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .audit-main {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .audit-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .footer-left, .footer-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary { background: var(--accent-cyan); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); }
        .btn-success { 
            background: #90ee90; /* Hellgrün als Basis */
            color: #1f2937; 
        }
        .btn-success.active { 
            background: #059669; /* Dunkelgrün wenn aktiv */
            color: white; 
        }
        .btn-danger { 
            background: #ffb3ba; /* Hellrot als Basis */
            color: #1f2937; 
        }
        .btn-danger.active { 
            background: #dc2626; /* Dunkelrot wenn aktiv */
            color: white; 
        }
        .btn-warning { 
            background: #ffd700; /* HellOrange/Gelb als Basis */
            color: #1f2937; 
        }
        .btn-warning.active { 
            background: #d97706; /* Dunkelorange wenn aktiv */
            color: white; 
        }
        .btn-info { 
            background: #add8e6; /* Hellblau als Basis */
            color: #1f2937; 
        }
        .btn-info.active { 
            background: #2563eb; /* Dunkelblau wenn aktiv */
            color: white; 
        }
        .btn-outline { 
            background: transparent; 
            color: var(--text-secondary); 
            border: 1px solid var(--border-primary); 
        }
        .btn-outline:hover { 
            background: var(--bg-card); 
            color: var(--text-primary); 
        }
        .btn-small { padding: 4px 8px; font-size: 12px; }

        .category-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--accent-cyan);
            color: white;
            border-color: var(--accent-cyan);
        }

        .test-point {
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .test-point:hover { border-color: var(--accent-cyan); }
        .test-point.status-success { border-color: #059669; }
        .test-point.status-error { border-color: #dc2626; }
        .test-point.status-warning { border-color: #d97706; }
        .test-point.status-info { border-color: #2563eb; }

        .test-point-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .test-point-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-success { background: #059669; color: white; }
        .status-error { background: #dc2626; color: white; }
        .status-warning { background: #d97706; color: white; }
        .status-info { background: #2563eb; color: white; }

        .input {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 8px 32px 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            width: 200px;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .close-btn {
            position: fixed;
            top: 24px;
            right: 16px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1001;
            font-size: 14px;
            font-weight: 500;
        }

        .close-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .flex { display: flex; }
        .align-center { align-items: center; }
        .gap-8 { gap: 8px; }
        .mb-0 { margin-bottom: 0; }
        .mb-16 { margin-bottom: 16px; }
        .text-cyan { color: var(--accent-cyan); }
        .text-secondary { color: var(--text-secondary); }
        .text-sm { font-size: 13px; }

        /* Print Styles für PDF-Export */
        @media print {
            body { 
                background: white !important; 
                color: black !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .audit-footer, .close-btn { display: none; }
            .test-point { 
                background: white !important; 
                color: black !important; 
                border: 1px solid #ccc !important;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--bg-card);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-cyan);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 8px 8px;
        }

        .config-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
        }

        .form-group textarea {
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="window.close()">✕ Schließen</button>
    
    <div class="audit-log-container">
        <div class="audit-log-header">
            <div class="flex align-center gap-8">
                <h2 class="mb-0 text-cyan">🔍 AuditLog-System - Vollbild</h2>
                <button class="btn btn-secondary" onclick="goBackToFavOrg()" title="Zurück zu FavOrg">
                    🔗 FavOrg
                </button>
            </div>
            <div class="header-input-group">
                <div class="input-close-wrapper">
                    <input 
                        type="text" 
                        class="input" 
                        id="newTestInput" 
                        placeholder="Neuer Testname..." 
                        onkeypress="handleInputKeyPress(event)"
                    />
                    <button class="close-input-btn" onclick="clearInput()" title="Input leeren">×</button>
                </div>
                <button class="btn btn-primary" onclick="addTest()" title="Neuen Test hinzufügen"><i data-lucide="plus"></i></button>
                <button class="btn btn-danger" onclick="removeTest()" title="Test entfernen"><i data-lucide="x"></i></button>
            </div>
        </div>

        <div class="audit-log-content">
            <div class="audit-sidebar">
                <h3 class="mb-16 text-cyan">📋 Test-Bereiche</h3>
                <div id="categoryList">
                    <!-- Wird von JavaScript gefüllt -->
                </div>
            </div>

            <div class="audit-main">
                <div class="flex align-center" style="justify-content: space-between; margin-bottom: 16px;">
                    <h3 class="mb-0 text-cyan" id="currentCategoryTitle">🎨 Allgemeines Design</h3>
                    <span class="status-badge status-info" id="testCount">4 Tests</span>
                </div>
                <div id="testList">
                    <!-- Wird von JavaScript gefüllt -->
                </div>
            </div>
        </div>

        <div class="audit-footer">
            <!-- Links: 5 Status-Filter Buttons -->
            <div class="footer-left">
                <button class="btn btn-primary active" onclick="setFilter('')" id="filterAll" title="Alle Tests anzeigen">Alle (0)</button>
                <button class="btn btn-success" onclick="setFilter('success')" id="filterSuccess" title="Nur bestandene Tests anzeigen"><i data-lucide="check"></i> (0)</button>
                <button class="btn btn-danger" onclick="setFilter('error')" id="filterError" title="Nur fehlgeschlagene Tests anzeigen"><i data-lucide="x"></i> (0)</button>
                <button class="btn btn-warning" onclick="setFilter('warning')" id="filterWarning" title="Nur Tests in Bearbeitung anzeigen"><i data-lucide="pickaxe"></i> (0)</button>
                <button class="btn btn-info" onclick="setFilter('info')" id="filterInfo" title="Nur übersprungene Tests anzeigen"><i data-lucide="captions-off"></i> (0)</button>
            </div>
            <!-- Rechts: 5 Aktions-Buttons -->
            <div class="footer-right">
                <button class="btn btn-secondary" onclick="openConfigDialog()" title="Berichts-Konfiguration bearbeiten">⚙️ Config</button>
                <button class="btn btn-secondary" onclick="saveToArchive()" title="Aktuellen Test-Stand ins Archiv speichern">💾 Test speichern</button>
                <button class="btn btn-secondary" onclick="toggleArchiveView()" id="archiveToggleBtn" title="Archivierte Berichte anzeigen">📁 Archiv (0)</button>
                <button class="btn btn-secondary" onclick="exportToPDF()" title="Quality Assurance-Bericht, also Qualitätssicherungsbericht.">📄 QA-Bericht</button>
                <button class="btn btn-secondary" onclick="resetAll()" title="Alle Test-Status und Notizen zurücksetzen">🗑️ Reset</button>
            </div>
        </div>
    </div>

    <!-- Config Dialog -->
    <div id="configDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ AuditLog Konfiguration</h3>
                <span class="close" onclick="closeConfigDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h4>📋 Berichts-Metadaten</h4>
                    <div class="form-group">
                        <label>HauptUser (Tester):</label>
                        <input type="text" id="configTester" value="Jörg Renelt" placeholder="Name des Testers">
                    </div>
                    <div class="form-group">
                        <label>Version:</label>
                        <input type="text" id="configVersion" value="v2.3.0" placeholder="z.B. v2.3.0">
                    </div>
                    <div class="form-group">
                        <label>Testumgebung:</label>
                        <input type="text" id="configEnvironment" value="Windows 11, Chrome 117" placeholder="z.B. Windows 11, Chrome 117">
                    </div>
                    <div class="form-group">
                        <label>Testziel:</label>
                        <textarea id="configTestGoal" placeholder="Beschreibung des Testziels">Überprüfung aller Funktionen und Fehlermeldungen des FavOrg AuditLog-Systems.</textarea>
                    </div>
                    <div class="form-group">
                        <label>Testmethodik:</label>
                        <textarea id="configTestMethodology" placeholder="Beschreibung der Testmethodik">Manueller Funktionstest mit definierten Testfällen. Eingaben über Web-Oberfläche, Auswertung durch visuelle Prüfung und Funktionsvalidierung.</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveConfigAndClose()">💾 Speichern</button>
                <button class="btn btn-secondary" onclick="closeConfigDialog()">❌ Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen - mit localStorage-Persistierung
        window.currentCategory = 'Allgemeines Design';
        window.testStatuses = JSON.parse(localStorage.getItem('favorg-audit-testStatuses') || '{}');
        window.testNotes = JSON.parse(localStorage.getItem('favorg-audit-testNotes') || '{}');
        window.statusFilter = '';
        window.archivedReports = JSON.parse(localStorage.getItem('favorg-audit-archivedReports') || '[]');
        window.viewMode = 'tests'; // 'tests' oder 'archive'
        
        // Config-Variablen (mit Defaults und LocalStorage-Persistierung)
        window.auditConfig = JSON.parse(localStorage.getItem('favorg-audit-config') || JSON.stringify({
            tester: 'Jörg Renelt',
            version: 'v2.3.0', // Systemvorgabe: aktuelle FavOrg Version
            environment: 'Windows 11, Chrome 117',
            testGoal: 'Überprüfung aller Funktionen und Fehlermeldungen des FavOrg AuditLog-Systems.',
            testMethodology: 'Manueller Funktionstest mit definierten Testfällen. Eingaben über Web-Oberfläche, Auswertung durch visuelle Prüfung und Funktionsvalidierung.'
        }));

        // Version-Update wenn veraltet
        if (window.auditConfig.version !== 'v2.3.0') {
            window.auditConfig.version = 'v2.3.0';
            localStorage.setItem('favorg-audit-config', JSON.stringify(window.auditConfig));
        }

        // Test-Kategorien - Erweiterte FavOrg Test-Suite + AuditLog Meta-Tests
        window.categories = [
            { name: 'AuditLog-System', icon: '📋', count: 12 },
            { name: 'AuditLog PDF-Export', icon: '📄', count: 8 },
            { name: 'AuditLog Archiv-System', icon: '📁', count: 7 },
            { name: 'AuditLog Config-System', icon: '⚙️', count: 8 },
            { name: 'AuditLog Lucide Icons', icon: '✨', count: 7 },
            { name: 'Allgemeines Design', icon: '🎨', count: 7 },
            { name: 'Header-Bereich', icon: '🔝', count: 7 },
            { name: 'Sidebar-Bereich', icon: '📋', count: 9 },
            { name: 'Main-Content', icon: '📄', count: 7 },
            { name: 'Bookmark-Karten', icon: '🎴', count: 11 },
            { name: 'Import/Export Funktionen', icon: '💾', count: 8 },
            { name: 'Link-Validierung', icon: '✅', count: 7 },
            { name: 'Such- & Filterfunktionen', icon: '🔍', count: 7 },
            { name: 'Einstellungen', icon: '⚙️', count: 8 },
            { name: 'Performance & Benutzerfreundlichkeit', icon: '⚡', count: 7 },
            { name: 'Drag & Drop System', icon: '🔄', count: 6 },
            { name: 'Easter Eggs & Spezialfunktionen', icon: '🎮', count: 4 }
        ];

        // Test-Daten - Erweiterte FavOrg Test-Suite + AuditLog Meta-Tests
        window.tests = {
            'AuditLog-System': [
                { name: 'Titel-Anzeige korrekt', icon: '📋', tooltip: 'Test-Bereiche Titel mit Counter wird korrekt angezeigt' },
                { name: 'Neuanlegen Funktion', icon: '➕', tooltip: 'Neue Testpunkte können hinzugefügt werden' },
                { name: 'Löschfunktion', icon: '🗑️', tooltip: 'Testpunkte können entfernt werden' },
                { name: 'Sidebar Counter-Logik', icon: '🔢', tooltip: 'Counter zeigen korrekte Anzahl offener Tests' },
                { name: 'Kategorie-Klick Navigation', icon: '👆', tooltip: 'Klick auf Kategorie zeigt alle Tests des Bereichs' },
                { name: 'Status-Button Funktionalität', icon: '🔘', tooltip: 'Alle 4 Status-Buttons (Success, Error, Warning, Info) funktional' },
                { name: 'Edit-Button Funktionalität', icon: '✏️', tooltip: 'Edit-Button öffnet Bearbeitungsdialog' },
                { name: 'Notiz-Button Funktionalität', icon: '📝', tooltip: 'Notiz-Button ermöglicht Kommentare zu Tests' },
                { name: 'Filter-System Footer', icon: '🔍', tooltip: 'Footer-Filter (Alle, Success, Error, Warning, Info) funktional' },
                { name: 'Counter-Update dynamisch', icon: '🔄', tooltip: 'Counter aktualisieren sich bei Status-Änderungen' },
                { name: 'Sidebar-Layout korrekt', icon: '📐', tooltip: 'Sidebar 10px Abstand, 100% Breite, korrekte Positionierung' },
                { name: 'Tooltips bei Buttons', icon: '💬', tooltip: 'Alle Buttons zeigen korrekte Tooltips bei Hover' }
            ],
            'AuditLog PDF-Export': [
                { name: 'QA-Bericht Button', icon: '📄', tooltip: 'Button heißt "QA-Bericht" mit korrektem Tooltip' },
                { name: 'PDF-Header Layout', icon: '🏷️', tooltip: 'Titel links, Version rechts im PDF-Header' },
                { name: 'Metadaten-Reihenfolge', icon: '👤', tooltip: 'Tester vor Datum in PDF-Metadaten' },
                { name: 'Gesamtübersicht Design', icon: '📊', tooltip: 'Nur Rahmen, keine Hintergrundfarbe in Gesamtübersicht' },
                { name: 'Bereichsüberschriften', icon: '🗂️', tooltip: 'Tests nach Kategorien gruppiert mit Überschriften' },
                { name: 'Alle Tests sichtbar', icon: '👁️', tooltip: 'Auch ungetestete Tests für Transparenz angezeigt' },
                { name: 'DIN A4 Optimierung', icon: '📄', tooltip: 'Kompakte Formatierung für Druckbarkeit' },
                { name: 'Print-Button interaktiv', icon: '🖱️', tooltip: 'Grauer Print-Button mit Hover-Effekt' }
            ],
            'AuditLog Archiv-System': [
                { name: 'Test speichern Funktion', icon: '💾', tooltip: 'Aktueller Test-Stand kann ins Archiv gespeichert werden' },
                { name: 'Archiv anzeigen Toggle', icon: '📁', tooltip: 'Wechsel zwischen Testpunkten und Archiv-Ansicht' },
                { name: 'Archiv-Counter korrekt', icon: '🔢', tooltip: 'Archiv-Button zeigt korrekte Anzahl gespeicherter Berichte' },
                { name: 'Anzeigen Button Archiv', icon: '👁️', tooltip: '👁️ Anzeigen Button für archivierte Berichte funktional' },
                { name: 'Laden Button Archiv', icon: '📥', tooltip: 'Archivierte Test-Stände können geladen werden' },
                { name: 'Löschen Button Archiv', icon: '🗑️', tooltip: 'Archivierte Berichte können entfernt werden' },
                { name: 'Archiv-Persistierung', icon: '💾', tooltip: 'Archivierte Daten bleiben nach Browser-Refresh erhalten' }
            ],
            'AuditLog Config-System': [
                { name: 'Config Dialog öffnen', icon: '⚙️', tooltip: 'Config-Button öffnet Konfigurationsdialog' },
                { name: 'Tester-Name Eingabe', icon: '👤', tooltip: 'Tester-Name kann eingegeben und gespeichert werden' },
                { name: 'Version Eingabe', icon: '🏷️', tooltip: 'Versions-Nummer kann eingegeben und gespeichert werden' },
                { name: 'Testumgebung Eingabe', icon: '💻', tooltip: 'Testumgebung kann eingegeben und gespeichert werden' },
                { name: 'Testziel Eingabe', icon: '🎯', tooltip: 'Testziel kann eingegeben und gespeichert werden' },
                { name: 'Testmethodik Eingabe', icon: '🔬', tooltip: 'Testmethodik kann eingegeben und gespeichert werden' },
                { name: 'Config speichern', icon: '💾', tooltip: 'Konfiguration wird korrekt gespeichert' },
                { name: 'Config persistieren', icon: '🔄', tooltip: 'Konfiguration bleibt nach Browser-Refresh erhalten' }
            ],
            'AuditLog Lucide Icons': [
                { name: 'Status Icons Check', icon: '✅', tooltip: 'Check-Icon für Success-Status funktional' },
                { name: 'Status Icons X', icon: '❌', tooltip: 'X-Icon für Error-Status funktional' },
                { name: 'Status Icons Pickaxe', icon: '⚠️', tooltip: 'Pickaxe-Icon für Warning-Status funktional' },
                { name: 'Status Icons CaptionsOff', icon: '📴', tooltip: 'CaptionsOff-Icon für Info-Status funktional' },
                { name: 'Edit Icon PencilLine', icon: '✏️', tooltip: 'PencilLine-Icon für Edit-Button funktional' },
                { name: 'Notiz Icon NotebookPen', icon: '📝', tooltip: 'NotebookPen-Icon für Notiz-Button funktional' },
                { name: 'Icons initialisierung', icon: '🔄', tooltip: 'Lucide Icons werden korrekt beim Laden initialisiert' }
            ],
            'Allgemeines Design': [
                { name: '80% UI-Kompaktheit', icon: '📱', tooltip: '80% kompakte UI-Darstellung prüfen' },
                { name: 'Dark Theme', icon: '🌙', tooltip: 'Dark Theme Konsistenz testen' },
                { name: 'Responsiveness', icon: '📐', tooltip: 'Responsive Layout auf verschiedenen Größen' },
                { name: 'Typographie', icon: '🔤', tooltip: 'Typographie und Schriftarten prüfen' },
                { name: 'Farbschema Konsistenz', icon: '🎨', tooltip: 'Einheitliches Farbschema in gesamter App' },
                { name: 'Loading-States', icon: '⏳', tooltip: 'Loading-Indikatoren bei Datenladung' },
                { name: 'Error-Boundaries', icon: '🚫', tooltip: 'Fehlerbehandlung und Error-States' }
            ],
            'Header-Bereich': [
                { name: 'Logo & Titel Platzierung', icon: '🏷️', tooltip: 'Logo und Titel korrekt positioniert' },
                { name: 'Navigation Icons', icon: '🧭', tooltip: 'Alle Navigation-Icons funktional' },
                { name: 'Bookmark-Anzahl [X]', icon: '🔢', tooltip: 'Bookmark-Counter korrekt angezeigt' },
                { name: 'Header-Buttons Layout', icon: '🔘', tooltip: 'Button-Layout im Header prüfen' },
                { name: 'Suchfeld Funktionalität', icon: '🔍', tooltip: 'Suchfeld responsive und funktional' },
                { name: 'Status-Filter Dropdown', icon: '📊', tooltip: 'Alle Status-Optionen verfügbar' },
                { name: 'Theme-Umschalter', icon: '🌓', tooltip: 'Light/Dark Theme Toggle funktional' }
            ],
            'Sidebar-Bereich': [
                { name: 'Kategorie-Liste', icon: '📂', tooltip: 'Kategorien korrekt aufgelistet' },
                { name: 'Drag & Drop Kategorien', icon: '🎯', tooltip: 'Kategorie D&D funktional' },
                { name: 'Resizing Funktionalität', icon: '↔️', tooltip: 'Sidebar-Größenänderung' },
                { name: 'Kategorie-Tooltips', icon: '💬', tooltip: 'Tooltip-Positionierung testen' },
                { name: 'Unterkategorie-Hierarchie', icon: '🌳', tooltip: 'Hierarchische Darstellung prüfen' },
                { name: 'Plus-Symbol für neue Kategorie', icon: '➕', tooltip: 'Kategorie-Erstellung über Plus-Symbol' },
                { name: 'Kategorie-Zähler', icon: '🔢', tooltip: 'Bookmark-Anzahl pro Kategorie' },
                { name: 'Aktive Kategorie-Markierung', icon: '🎯', tooltip: 'Visuelle Hervorhebung aktiver Kategorie' },
                { name: 'Kategorie-Manager Dialog', icon: '⚙️', tooltip: 'Live-Kategorien-Verwaltung Dialog' }
            ],
            'Main-Content': [
                { name: 'Bookmark-Darstellung', icon: '🎴', tooltip: 'Bookmark-Karten Layout' },
                { name: 'Tabellen-Ansicht Toggle', icon: '📋', tooltip: 'List/Grid View umschalten' },
                { name: 'Scroll-Performance', icon: '📜', tooltip: 'Scrolling bei vielen Bookmarks' },
                { name: 'Leere-State Anzeige', icon: '📭', tooltip: 'Anzeige wenn keine Bookmarks' },
                { name: 'Pagination/Infinite Scroll', icon: '📄', tooltip: 'Seitennummerierung oder unendliches Scrollen' },
                { name: 'Sortierung-Optionen', icon: '🔤', tooltip: 'Alphabetische und andere Sortierungen' },
                { name: 'Bulk-Aktionen', icon: '📦', tooltip: 'Mehrfach-Auswahl und Bulk-Operationen' }
            ],
            'Bookmark-Karten': [
                { name: 'Status-Farb-System', icon: '🎨', tooltip: 'Farben für verschiedene Status' },
                { name: 'Lock/Unlock Buttons', icon: '🔒', tooltip: 'Sperr-Funktionalität testen' },
                { name: 'Action-Buttons Layout', icon: '🔘', tooltip: 'Edit/Delete/Link Button-Layout' },
                { name: 'Drag-Handles sichtbar', icon: '⋮⋮', tooltip: 'Drag-Griffe erkennbar' },
                { name: 'Hover-States', icon: '👆', tooltip: 'Hover-Effekte auf Karten' },
                { name: 'Status-Badge Position', icon: '🏷️', tooltip: 'Status-Badges korrekt positioniert' },
                { name: 'Favicon-Anzeige', icon: '🌐', tooltip: 'Website-Favicons korrekt geladen' },
                { name: 'URL-Validierung Anzeige', icon: '✅', tooltip: 'Link-Status visuell erkennbar' },
                { name: 'Bookmark-Beschreibung', icon: '📝', tooltip: 'Vollständige Beschreibung sichtbar' },
                { name: 'Zeitstempel-Anzeige', icon: '⏰', tooltip: 'Erstellungs- und Änderungsdatum' },
                { name: 'Kategorie-Zuordnung visuell', icon: '🏷️', tooltip: 'Kategorie-Zugehörigkeit erkennbar' }
            ],
            'Import/Export Funktionen': [
                { name: 'HTML-Import', icon: '📄', tooltip: 'Browser-Favoriten HTML Import' },
                { name: 'JSON-Export', icon: '💾', tooltip: 'JSON Format Export funktional' },
                { name: 'CSV-Export', icon: '📊', tooltip: 'CSV Format für Excel-Bearbeitung' },
                { name: 'XML-Export', icon: '🗂️', tooltip: 'XML Format Export' },
                { name: 'HTML-Export', icon: '🌐', tooltip: 'HTML Format Export für Browser' },
                { name: 'Datei-Upload Dialog', icon: '📤', tooltip: 'Upload-Interface benutzerfreundlich' },
                { name: 'Import-Fortschritt', icon: '⏳', tooltip: 'Fortschrittsanzeige bei großen Imports' },
                { name: 'Import-Validation', icon: '✔️', tooltip: 'Dateiformate-Validierung vor Import' }
            ],
            'Link-Validierung': [
                { name: 'Tote Links Erkennung', icon: '💀', tooltip: 'Dead Links automatisch erkennen' },
                { name: 'HTTP Status Codes', icon: '🔢', tooltip: 'Korrekte HTTP Status Code Anzeige' },
                { name: 'Batch-Validierung', icon: '🔄', tooltip: 'Mehrere Links gleichzeitig prüfen' },
                { name: 'Validierungs-Fortschritt', icon: '📊', tooltip: 'Progress-Bar bei Validierung' },
                { name: 'Localhost-Links Schutz', icon: '🏠', tooltip: 'Localhost-Links vor Löschung schützen' },
                { name: 'Timeout-Behandlung', icon: '⏱️', tooltip: 'Timeout bei langsamen Servern' },
                { name: 'SSL-Zertifikat Prüfung', icon: '🔐', tooltip: 'HTTPS-Zertifikat Validierung' }
            ],
            'Such- & Filterfunktionen': [
                { name: 'Global-Suche', icon: '🔍', tooltip: 'Suche in allen Bookmarks' },
                { name: 'Kategorie-Filter', icon: '📂', tooltip: 'Filter nach spezifischen Kategorien' },
                { name: 'Status-Filter', icon: '🚦', tooltip: 'Filter nach Link-Status' },
                { name: 'Erweiterte Suche', icon: '🔍', tooltip: 'Titel, URL, Beschreibung durchsuchbar' },
                { name: 'Suche-Highlighting', icon: '🔆', tooltip: 'Suchbegriffe visuell hervorgehoben' },
                { name: 'Gespeicherte Suchen', icon: '💾', tooltip: 'Häufige Suchen speichern' },
                { name: 'Filter-Kombinationen', icon: '⚡', tooltip: 'Mehrere Filter gleichzeitig' }
            ],
            'Einstellungen': [
                { name: 'Tab-Navigation Icons', icon: '🗂️', tooltip: 'Settings-Tabs mit Icons' },
                { name: 'Theme-Einstellungen', icon: '🌙', tooltip: 'Dark/Light Theme Toggle' },
                { name: 'Meldungen Delay Checkbox', icon: '⏰', tooltip: 'Toast-Delay Einstellung' },
                { name: 'Gefahr-Bereich rot', icon: '⚠️', tooltip: 'Danger-Zone rote Markierung' },
                { name: 'Auto-Validierung Timer', icon: '🕐', tooltip: 'Automatische Link-Prüfung Intervall' },
                { name: 'Import-Einstellungen', icon: '📥', tooltip: 'Standard Import-Optionen' },
                { name: 'Export-Formate', icon: '📤', tooltip: 'Standard Export-Einstellungen' },
                { name: 'Backup-Konfiguration', icon: '💾', tooltip: 'Automatische Backups konfigurieren' }
            ],
            'Performance & Benutzerfreundlichkeit': [
                { name: 'Ladezeit unter 2 Sekunden', icon: '⚡', tooltip: 'Initiale Ladezeit optimiert' },
                { name: 'Keyboard-Shortcuts', icon: '⌨️', tooltip: 'Tastatur-Navigation funktional' },
                { name: 'Mobile-Responsive', icon: '📱', tooltip: 'Mobile Darstellung optimiert' },
                { name: 'Touch-Gesten', icon: '👆', tooltip: 'Touch-Bedienung auf Tablets' },
                { name: 'Offline-Funktionalität', icon: '📡', tooltip: 'Grundfunktionen offline verfügbar' },
                { name: 'Browser-Kompatibilität', icon: '🌍', tooltip: 'Chrome, Firefox, Safari, Edge' },
                { name: 'Memory-Usage', icon: '🧠', tooltip: 'Speicherverbrauch bei 1000+ Bookmarks' }
            ],
            'Drag & Drop System': [
                { name: 'Bookmark zwischen Kategorien', icon: '🔄', tooltip: 'Bookmarks zwischen Kategorien verschieben' },
                { name: 'Excel-ähnliches D&D', icon: '📊', tooltip: 'Excel-ähnliche Drag & Drop Funktionen' },
                { name: 'Shift-Modus Einfügen', icon: '⇧', tooltip: 'Shift-Modus für präzises Einfügen' },
                { name: 'Visual Drop-Feedback', icon: '👁️', tooltip: 'Visuelle Rückmeldung beim Ziehen' },
                { name: 'Cross-Level D&D', icon: '🔀', tooltip: 'Zwischen Haupt- und Unterkategorien' },
                { name: 'Undo/Redo Funktionalität', icon: '↶', tooltip: 'Rückgängig/Wiederholen von Aktionen' }
            ],
            'Easter Eggs & Spezialfunktionen': [
                { name: 'Catch-Mouse Game', icon: '🐭', tooltip: 'Alt+G öffnet Catch-Mouse Spiel' },
                { name: 'Keyboard-Shortcuts Alt+G', icon: '🎮', tooltip: 'Alt+G Shortcut funktional' },
                { name: 'Copyright-Klick Funktion', icon: '©️', tooltip: 'Copyright-Bereich klickbar' },
                { name: 'Versteckte Funktionen', icon: '🕵️', tooltip: 'Weitere versteckte Features entdecken' }
            ]
        };

        // Render-Funktionen
        function updateSidebarTitle() {
            const totalOpen = window.categories.reduce((total, cat) => total + cat.count, 0);
            const titleElement = document.querySelector('.audit-sidebar h3');
            if (titleElement) {
                titleElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>📋 Test-Bereiche</span>
                        <span style="background: #d97706; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                            ${totalOpen} offen
                        </span>
                    </div>
                `;
            }
        }

        function renderCategories() {
            console.log('🎨 renderCategories() aufgerufen');
            const container = document.getElementById('categoryList');
            if (!container) return;
            
            container.innerHTML = '';
            
            window.categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn ' + (category.name === window.currentCategory ? 'active' : '');
                btn.onclick = function() { 
                    selectCategory(category.name);
                    // Alle Tests der Kategorie anzeigen (Filter zurücksetzen)
                    setFilter('');
                };
                
                btn.innerHTML = '<span>' + category.icon + '</span>' +
                               '<span style="flex: 1;">' + category.name + '</span>' +
                               '<span class="status-badge status-info">' + category.count + '</span>';
                
                container.appendChild(btn);
            });
            
            // Aktualisiere den Sidebar-Titel mit dem Counter
            updateSidebarTitle();
        }

        function renderTests() {
            console.log('🧪 renderTests() aufgerufen');
            const container = document.getElementById('testList');
            if (!container) return;
            
            const tests = window.tests[window.currentCategory] || [];
            let filteredTests = tests;
            
            if (window.statusFilter) {
                filteredTests = tests.filter(test => window.testStatuses[test.name] === window.statusFilter);
            }
            
            container.innerHTML = '';
            document.getElementById('testCount').textContent = filteredTests.length + ' Tests';

            if (filteredTests.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">' +
                                    '<p>Keine Tests für "' + window.currentCategory + '" gefunden.</p>' +
                                    '</div>';
                return;
            }

            filteredTests.forEach(function(test) {
                const testStatus = window.testStatuses[test.name];
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-point ' + (testStatus ? 'status-' + testStatus : '');
                
                let statusBadgeHtml = '';
                if (testStatus) {
                    const statusConfig = {
                        'success': { icon: '✅', text: 'Bestanden' },
                        'error': { icon: '❌', text: 'Fehlgeschlagen' },
                        'warning': { icon: '⏳', text: 'In Bearbeitung' },
                        'info': { icon: '🗑️', text: 'Übersprungen' }
                    };
                    const config = statusConfig[testStatus];
                    if (config) {
                        statusBadgeHtml = '<span class="status-badge status-' + testStatus + '">' + config.icon + ' ' + config.text + '</span>';
                    }
                }

                testDiv.innerHTML = 
                    '<div class="test-point-header">' +
                        '<div class="flex align-center gap-8">' +
                            '<span style="font-size: 16px;">' + test.icon + '</span>' +
                            '<div style="flex: 1;"><strong>' + test.name + '</strong></div>' +
                        '</div>' +
                        statusBadgeHtml +
                    '</div>' +
                    '<p class="text-secondary text-sm" style="margin: 4px 0 8px 0;">' + test.tooltip + '</p>' +
                    '<div class="test-point-actions">' +
                        '<button class="btn btn-success btn-small' + (testStatuses[test.name] === 'success' ? ' active' : '') + '" onclick="setTestStatus(\'' + test.name + '\', \'success\')" title="Test bestanden"><i data-lucide="check"></i></button>' +
                        '<button class="btn btn-danger btn-small' + (testStatuses[test.name] === 'error' ? ' active' : '') + '" onclick="setTestStatus(\'' + test.name + '\', \'error\')" title="Test fehlgeschlagen"><i data-lucide="x"></i></button>' +
                        '<button class="btn btn-warning btn-small' + (testStatuses[test.name] === 'warning' ? ' active' : '') + '" onclick="setTestStatus(\'' + test.name + '\', \'warning\')" title="Test in Bearbeitung"><i data-lucide="pickaxe"></i></button>' +
                        '<button class="btn btn-info btn-small' + (testStatuses[test.name] === 'info' ? ' active' : '') + '" onclick="setTestStatus(\'' + test.name + '\', \'info\')" title="Test übersprungen"><i data-lucide="captions-off"></i></button>' +
                        '<button class="btn btn-outline btn-small" onclick="editTest(\'' + test.name + '\')" title="Test bearbeiten"><i data-lucide="pencil-line"></i> Edit</button>' +
                        '<button class="btn btn-outline btn-small" onclick="addNote(\'' + test.name + '\')" title="Notiz hinzufügen oder bearbeiten"><i data-lucide="notebook-pen"></i> Notiz</button>' +
                    '</div>';
                
                container.appendChild(testDiv);
            });
            
            // Initialisiere Lucide Icons nach dem Rendern
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Event-Handler
        function selectCategory(categoryName) {
            window.currentCategory = categoryName;
            const category = window.categories.find(function(cat) { return cat.name === categoryName; });
            if (category) {
                document.getElementById('currentCategoryTitle').textContent = category.icon + ' ' + categoryName;
            }
            renderCategories();
            renderTests();
        }

        function setTestStatus(testName, status) {
            window.testStatuses[testName] = status;
            renderTests();
            updateStatusCounts();
        }

        function updateStatusCounts() {
            const allStatuses = Object.values(window.testStatuses);
            const counts = {
                all: allStatuses.length,
                success: allStatuses.filter(function(s) { return s === 'success'; }).length,
                error: allStatuses.filter(function(s) { return s === 'error'; }).length,
                warning: allStatuses.filter(function(s) { return s === 'warning'; }).length,
                info: allStatuses.filter(function(s) { return s === 'info'; }).length
            };

            document.getElementById('filterAll').textContent = 'Alle (' + counts.all + ')';
            document.getElementById('filterSuccess').textContent = '✅ (' + counts.success + ')';
            document.getElementById('filterError').textContent = '❌ (' + counts.error + ')';
            document.getElementById('filterWarning').textContent = '⏳ (' + counts.warning + ')';
            document.getElementById('filterInfo').textContent = '🗑️ (' + counts.info + ')';
        }

        function updateArchiveCount() {
            const btn = document.getElementById('archiveToggleBtn');
            if (window.viewMode === 'archive') {
                btn.textContent = '📋 Testpunkte';
                btn.title = 'Zurück zu Testpunkten';
            } else {
                btn.textContent = '📁 Archiv (' + window.archivedReports.length + ')';
                btn.title = 'Archiv anzeigen';
            }
        }

        function toggleArchiveView() {
            if (window.viewMode === 'archive') {
                // Zurück zu Tests
                window.viewMode = 'tests';
                renderCategories();
                renderTests();
            } else {
                // Zu Archiv wechseln
                window.viewMode = 'archive';
                renderArchiveView();
            }
            updateArchiveCount();
        }

        function renderArchiveView() {
            const categoryContainer = document.getElementById('categoryList');
            const testContainer = document.getElementById('testList');
            
            // Sidebar für Archiv
            categoryContainer.innerHTML = '<h4 class="text-cyan mb-16">📁 Gespeicherte Berichte</h4>';
            
            // Main-Bereich für Archiv
            if (window.archivedReports.length === 0) {
                testContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 18px; margin-bottom: 16px;">📁 Keine archivierten Berichte vorhanden</p>
                        <p>Speichern Sie Tests mit dem "💾 Test speichern" Button, um Berichte zu erstellen.</p>
                    </div>
                `;
            } else {
                let archiveHtml = '';
                window.archivedReports.forEach((report, index) => {
                    archiveHtml += `
                        <div class="test-point" style="border-color: var(--accent-cyan);">
                            <div class="test-point-header">
                                <div class="flex align-center gap-8">
                                    <span style="font-size: 16px;">📊</span>
                                    <div style="flex: 1;">
                                        <strong>${report.category}</strong>
                                        <div class="text-secondary text-sm">${report.timestamp}</div>
                                    </div>
                                </div>
                                <span class="status-badge status-info">${report.completedTests}/${report.totalTests} Tests</span>
                            </div>
                            <p class="text-secondary text-sm" style="margin: 4px 0 8px 0;">
                                Bericht erstellt am ${report.timestamp} mit ${report.completedTests} abgeschlossenen Tests
                            </p>
                            <div class="test-point-actions">
                                <button class="btn btn-info btn-small" onclick="viewReport(${index})" title="Bericht anzeigen"><i data-lucide="eye"></i> Anzeigen</button>
                                <button class="btn btn-primary btn-small" onclick="loadReport(${index})" title="Bericht laden"><i data-lucide="download"></i> Laden</button>
                                <button class="btn btn-danger btn-small" onclick="deleteReport(${index})" title="Bericht löschen"><i data-lucide="trash-2"></i> Löschen</button>
                            </div>
                        </div>
                    `;
                });
                testContainer.innerHTML = archiveHtml;
            }
            
            document.getElementById('testCount').textContent = window.archivedReports.length + ' Berichte';
            
            // Initialisiere Lucide Icons nach dem Rendern
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            document.getElementById('currentCategoryTitle').textContent = '📁 Archivierte Test-Berichte';
        }

        function loadReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            // Lade gespeicherte Test-Status
            window.testStatuses = {...report.testStatuses};
            window.testNotes = {...report.testNotes};
            window.currentCategory = report.category;
            
            // Zurück zur Test-Ansicht
            window.viewMode = 'tests';
            renderCategories();
            renderTests();
            updateStatusCounts();
            updateArchiveCount();
            
            alert(`Bericht "${report.category}" vom ${report.timestamp} wurde geladen`);
        }

        function deleteReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            if (confirm(`Bericht "${report.category}" vom ${report.timestamp} löschen?`)) {
                window.archivedReports.splice(index, 1);
                localStorage.setItem('favorg-audit-archive', JSON.stringify(window.archivedReports));
                renderArchiveView();
                updateArchiveCount();
                alert('Bericht gelöscht');
            }
        }

        function viewReport(index) {
            const report = window.archivedReports[index];
            if (!report) return;
            
            // Rekonstruiere die Tests aus dem gespeicherten Bericht
            const savedTests = Object.keys(report.testStatuses).map(testName => ({
                name: testName,
                icon: '📋', // Default Icon
                tooltip: report.testNotes[testName] || 'Test aus Archiv',
                category: report.category,
                categoryIcon: getCategoryIcon(report.category)
            }));
            
            const testResults = calculateTestResults(savedTests, report.testStatuses, report.testNotes);
            
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(generateStructuredReport(savedTests, testResults, report.timestamp, report.category, report.testStatuses, report.testNotes));
            printWindow.document.close();
            
            console.log(`Bericht "${report.category}" wird angezeigt`);
        }

        function setFilter(filter) {
            window.statusFilter = filter;
            
            // Aktualisiere Button-Status (aktive CSS-Klassen)
            const allButtons = ['filterAll', 'filterSuccess', 'filterError', 'filterWarning', 'filterInfo'];
            allButtons.forEach(buttonId => {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.remove('active');
                }
            });
            
            // Markiere aktiven Button
            let activeButtonId = '';
            switch(filter) {
                case '': activeButtonId = 'filterAll'; break;
                case 'success': activeButtonId = 'filterSuccess'; break;
                case 'error': activeButtonId = 'filterError'; break;
                case 'warning': activeButtonId = 'filterWarning'; break;
                case 'info': activeButtonId = 'filterInfo'; break;
            }
            
            const activeBtn = document.getElementById(activeButtonId);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            renderTests();
        }

        // Input-Handler
        function handleInputKeyPress(event) {
            if (event.key === 'Enter') {
                addTest();
            }
        }

        function clearInput() {
            document.getElementById('newTestInput').value = '';
        }

        function addTest() {
            const input = document.getElementById('newTestInput');
            const testName = input.value.trim();
            
            if (!testName) {
                alert('Bitte geben Sie einen Testnamen ein');
                return;
            }
            
            if (!window.tests[window.currentCategory]) {
                window.tests[window.currentCategory] = [];
            }
            
            window.tests[window.currentCategory].push({
                name: testName,
                icon: '🔍',
                tooltip: 'Benutzerdefinierter Test'
            });
            
            input.value = '';
            renderTests();
        }

        function removeTest() {
            const input = document.getElementById('newTestInput');
            const testName = input.value.trim();
            
            if (!testName) {
                alert('Bitte geben Sie den Namen des zu löschenden Tests ein');
                return;
            }
            
            const tests = window.tests[window.currentCategory] || [];
            const newTests = tests.filter(function(test) { return test.name !== testName; });
            
            if (newTests.length === tests.length) {
                alert('Test "' + testName + '" nicht gefunden');
                return;
            }
            
            window.tests[window.currentCategory] = newTests;
            delete window.testStatuses[testName];
            
            input.value = '';
            renderTests();
        }

        // Archiv-Funktionen
        function saveToArchive() {
            const tests = window.tests[window.currentCategory] || [];
            const completedTests = tests.filter(test => window.testStatuses[test.name]);
            
            if (completedTests.length === 0) {
                alert('Keine Tests mit Status zum Speichern gefunden');
                return;
            }
            
            const report = {
                id: Date.now(),
                category: window.currentCategory,
                timestamp: new Date().toLocaleString('de-DE'),
                totalTests: tests.length,
                completedTests: completedTests.length,
                testStatuses: {...window.testStatuses},
                testNotes: {...window.testNotes}
            };
            
            window.archivedReports.unshift(report);
            
            // Nur die letzten 10 Berichte behalten
            if (window.archivedReports.length > 10) {
                window.archivedReports = window.archivedReports.slice(0, 10);
            }
            
            localStorage.setItem('favorg-audit-archive', JSON.stringify(window.archivedReports));
            updateArchiveCount();
            
            alert('Test-Stand für "' + window.currentCategory + '" ins Archiv gespeichert (' + completedTests.length + ' Tests)');
        }



        // Alle Tests aller Kategorien sammeln (für vollständigen PDF-Export)
        function getAllTests() {
            let allTests = [];
            const categories = Object.keys(window.tests);
            
            categories.forEach(category => {
                const categoryTests = window.tests[category] || [];
                const testsWithCategory = categoryTests.map(test => ({
                    ...test,
                    category: category,
                    categoryIcon: getCategoryIcon(category)
                }));
                allTests = [...allTests, ...testsWithCategory];
            });
            
            return allTests;
        }

        function getCategoryIcon(category) {
            const icons = {
                'Allgemeines Design': '🎨',
                'Header-Bereich': '🔝',
                'Sidebar-Bereich': '📋',
                'Main-Content': '📄',
                'Bookmark-Karten': '🎴',
                'Einstellungen': '⚙️'
            };
            return icons[category] || '📂';
        }

        // Erweiterte PDF-Export Funktion mit strukturiertem Bericht
        function exportToPDF() {
            const tests = getAllTests(); // Verwende ALLE Tests statt nur aktuelle Kategorie
            const testResults = calculateTestResults(tests);
            const currentDate = new Date().toLocaleString('de-DE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(generateStructuredReport(tests, testResults, currentDate, 'Alle Bereiche'));
            printWindow.document.close();
        }

        // Hilfsfunktion zur Berechnung der Testergebnisse
        function calculateTestResults(tests, customStatuses = null, customNotes = null) {
            // Verwende custom Status/Notes für Archiv-Berichte oder aktuelle für Live-Export
            const statusesToUse = customStatuses || window.testStatuses;
            const notesToUse = customNotes || window.testNotes;
            let total = tests.length;
            let passed = 0;
            let failed = 0;
            let warning = 0;
            let ungeprüft = 0;
            let issues = [];
            
            tests.forEach(test => {
                const status = statusesToUse[test.name] || 'ungeprüft';
                switch(status) {
                    case 'success':
                        passed++;
                        break;
                    case 'error':
                        failed++;
                        issues.push({
                            name: test.name,
                            type: 'FEHLER',
                            description: notesToUse[test.name] || 'Kritischer Fehler festgestellt'
                        });
                        break;
                    case 'warning':
                        warning++;
                        issues.push({
                            name: test.name,
                            type: 'WARNUNG',
                            description: notesToUse[test.name] || 'Verbesserung empfohlen'
                        });
                        break;
                    default:
                        ungeprüft++;
                }
            });
            
            return { total, passed, failed, warning, ungeprüft, issues };
        }

        // Hilfsfunktion zur Generierung des strukturierten Berichts
        function generateStructuredReport(tests, results, currentDate, reportCategory = null, customStatuses = null, customNotes = null) {
            // Verwende custom Status/Notes für Archiv-Berichte oder aktuelle für Live-Export
            const statusesToUse = customStatuses || window.testStatuses;
            const notesToUse = customNotes || window.testNotes;
            const categoryToShow = reportCategory || window.currentCategory;
            
            // Gruppiere Tests nach Kategorien für bessere Übersichtlichkeit
            const testsByCategory = {};
            tests.forEach(test => {
              const category = test.category || categoryToShow || 'Sonstige';
              if (!testsByCategory[category]) {
                testsByCategory[category] = [];
              }
              testsByCategory[category].push(test);
            });
            
            return `
                <!DOCTYPE html>
                <html lang="de">
                <head>
                    <meta charset="UTF-8">
                    <title>Testbericht · FavOrg</title>
                    <style>
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 20px; 
                            background: white !important;
                            color: #333 !important;
                            line-height: 1.4;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            font-size: 11pt;
                        }
                        .report-header { 
                            text-align: center; 
                            border-bottom: 3px solid #06b6d4; 
                            padding-bottom: 20px; 
                            margin-bottom: 25px;
                            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                            padding: 25px;
                            border-radius: 8px;
                        }
                        .report-header h1 {
                            color: #1a365d !important;
                            font-size: 28px;
                            margin-bottom: 8px;
                            font-weight: 700;
                        }
                        .metadata-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 20px;
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 6px;
                            border-left: 4px solid #06b6d4;
                        }
                        .metadata-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 6px 0;
                            border-bottom: 1px solid #e2e8f0;
                            font-size: 10pt;
                        }
                        .metadata-label {
                            font-weight: 600;
                            color: #374151;
                        }
                        .metadata-value {
                            color: #1f2937;
                            font-weight: 500;
                        }
                        .section {
                            margin-bottom: 25px;
                            padding: 15px;
                            border-radius: 6px;
                            border: 1px solid #e5e7eb;
                        }
                        .section h2 {
                            color: #111827 !important;
                            font-size: 16pt;
                            margin-bottom: 12px;
                            padding-bottom: 6px;
                            border-bottom: 2px solid #111827;
                        }
                        .category-section {
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .category-title {
                            color: #06b6d4 !important;
                            font-size: 14pt;
                            font-weight: 700;
                            margin-bottom: 10px;
                            padding: 8px 12px;
                            background: #f0f9ff;
                            border-left: 4px solid #06b6d4;
                            border-radius: 4px;
                        }
                        .test-case {
                            padding: 12px;
                            margin-bottom: 8px;
                            border: 1px solid #e5e7eb;
                            border-radius: 4px;
                            background: white;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            font-size: 10pt;
                        }
                        .test-case.success { border-color: #10b981; background: #f0fdf4; }
                        .test-case.error { border-color: #ef4444; background: #fef2f2; }
                        .test-case.warning { border-color: #f59e0b; background: #fffbeb; }
                        .test-case.ungeprüft { border-color: #6b7280; background: #f9fafb; }
                        .test-info {
                            flex: 1;
                        }
                        .test-name {
                            font-weight: 600;
                            font-size: 11pt;
                            margin-bottom: 4px;
                        }
                        .test-description {
                            color: #6b7280;
                            font-size: 9pt;
                            margin-bottom: 6px;
                        }
                        .test-notes {
                            font-style: italic;
                            color: #4b5563;
                            font-size: 9pt;
                        }
                        .status-badge {
                            padding: 6px 12px;
                            border-radius: 15px;
                            font-weight: 600;
                            font-size: 9pt;
                            text-align: center;
                            min-width: 70px;
                        }
                        .status-success { background: #10b981; color: white; }
                        .status-error { background: #ef4444; color: white; }
                        .status-warning { background: #f59e0b; color: white; }
                        .status-ungeprüft { background: #6b7280; color: white; }
                        
                        /* Gesamtübersicht - Nur Rahmen, keine Hintergrundfarbe */
                        .results-summary {
                            border: 2px solid #374151;
                            color: #1f2937 !important;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 20px;
                            background: white !important;
                            page-break-inside: avoid;
                        }
                        .results-summary h2 {
                            margin-top: 0;
                            color: #1f2937 !important;
                            font-size: 14pt;
                            margin-bottom: 10px;
                        }
                        .results-summary p {
                            color: #1f2937 !important;
                            font-size: 10pt;
                            margin-bottom: 12px;
                            line-height: 1.3;
                        }
                        .results-grid {
                            display: grid;
                            grid-template-columns: repeat(5, 1fr);
                            gap: 8px;
                            margin-top: 10px;
                        }
                        .result-item {
                            text-align: center;
                            background: white;
                            border: 1px solid #d1d5db;
                            padding: 8px 4px;
                            border-radius: 4px;
                        }
                        .result-number {
                            font-size: 16pt;
                            font-weight: bold;
                            display: block;
                            color: #1f2937 !important;
                        }
                        .result-label {
                            font-size: 8pt;
                            opacity: 0.8;
                            line-height: 1.1;
                            color: #6b7280;
                        }
                        
                        .issues-list {
                            list-style: none;
                            padding: 0;
                        }
                        .issue-item {
                            background: #fef2f2;
                            border-left: 4px solid #ef4444;
                            padding: 12px;
                            margin-bottom: 8px;
                            border-radius: 0 4px 4px 0;
                            font-size: 10pt;
                        }
                        .issue-type {
                            font-weight: 700;
                            color: #dc2626;
                            font-size: 10pt;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 16px;
                            background: #6b7280;
                            color: white;
                            border: 1px solid #4b5563;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            transition: all 0.2s;
                        }
                        .print-btn:hover {
                            background: #4b5563;
                            transform: translateY(-1px);
                        }
                        @media print {
                            body { 
                                background: white !important; 
                                color: #333 !important;
                                margin: 15px !important;
                                font-size: 10pt;
                            }
                            .print-btn { display: none; }
                            .section, .category-section { page-break-inside: avoid; }
                            .report-header { page-break-after: avoid; }
                            .results-summary { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">📄 Bericht drucken</button>
                    
                    <div class="report-header" style="text-align: left;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h1 style="text-align: left; margin: 0;">📋 Testbericht · FavOrg</h1>
                            <span style="font-size: 18pt; font-weight: 600; color: #06b6d4;">🏷️ ${window.auditConfig.version}</span>
                        </div>
                        <p style="font-size: 14pt; color: #64748b; margin-bottom: 20px;">AuditLog-System Qualitätsprüfung</p>
                        
                        <!-- Metadaten kompakt gruppiert - Tester vor Datum -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="font-weight: 600; font-size: 11pt;">👤 ${window.auditConfig.tester}</span>
                                <span style="font-weight: 600; font-size: 11pt;">📅 ${currentDate}</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <span style="font-weight: 600; font-size: 11pt;">💻 Testumgebung:</span> ${window.auditConfig.environment}
                        </div>

                        <!-- Kompakte Gesamtübersicht für DIN A4 - Nur Rahmen -->
                        <div class="results-summary">
                            <h2>📊 Gesamtübersicht</h2>
                            <p>
                                ${results.passed} von ${results.total} Testfällen bestanden.
                                ${results.failed > 0 ? ' Es wurden ' + results.failed + ' kritische Fehler festgestellt.' : ' Alle kritischen Tests erfolgreich.'}
                                ${results.ungeprüft > 0 ? ` ${results.ungeprüft} Testfälle wurden nicht geprüft.` : ''}
                            </p>
                            <div class="results-grid">
                                <div class="result-item">
                                    <span class="result-number">${results.total}</span>
                                    <span class="result-label">Gesamt</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-number">${results.passed}</span>
                                    <span class="result-label">✅ Bestanden</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-number">${results.failed}</span>
                                    <span class="result-label">❌ Fehler</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-number">${results.warning}</span>
                                    <span class="result-label">⚠️ Warnung</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-number">${results.ungeprüft}</span>
                                    <span class="result-label">⏳ Ungeprüft</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seitenumbruch für neue Seite -->
                    <div style="page-break-before: always;">
                        <div class="section">
                            <h2>🎯 Ziel des Tests</h2>
                            <p>${window.auditConfig.testGoal}</p>
                        </div>

                        <div class="section">
                            <h2>📋 Testobjekt</h2>
                            <p><strong>Testbereich:</strong> ${categoryToShow}</p>
                            <p>Testpunkte werden systematisch auf Funktionalität, Design-Konsistenz und Benutzerfreundlichkeit überprüft.</p>
                        </div>

                        <div class="section">
                            <h2>🔬 Testmethodik</h2>
                            <p>${window.auditConfig.testMethodology}</p>
                        </div>
                    </div>

                    <!-- Testfälle mit Bereichsüberschriften - ALLE Tests (auch ungetestete) -->
                    <div style="page-break-before: always;">
                        <div class="section">
                            <h2>🧪 Testfälle nach Bereichen (Alle Tests für Transparenz)</h2>
                            <p style="color: #6b7280; font-style: italic; margin-bottom: 20px;">
                                <strong>Hinweis:</strong> Zur Transparenz und Risikoabschätzung werden alle definierten Testpunkte aufgeführt, 
                                unabhängig davon ob sie bereits getestet wurden oder nicht.
                            </p>
                            ${Object.keys(testsByCategory).map(category => {
                                const categoryTests = testsByCategory[category];
                                return `
                                    <div class="category-section">
                                        <div class="category-title">
                                            ${getCategoryIcon(category)} ${category} (${categoryTests.length} Tests)
                                        </div>
                                        ${categoryTests.map((test, index) => {
                                            const status = statusesToUse[test.name] || 'ungeprüft';
                                            const notes = notesToUse[test.name];
                                            let statusText = '';
                                            let statusClass = '';
                                            
                                            switch(status) {
                                                case 'success':
                                                    statusText = 'OK';
                                                    statusClass = 'success';
                                                    break;
                                                case 'error':
                                                    statusText = 'FEHLER';
                                                    statusClass = 'error';
                                                    break;
                                                case 'warning':
                                                    statusText = 'WARNUNG';  
                                                    statusClass = 'warning';
                                                    break;
                                                default:
                                                    statusText = 'UNGEPRÜFT';
                                                    statusClass = 'ungeprüft';
                                            }
                                            
                                            return `
                                                <div class="test-case ${statusClass}">
                                                    <div class="test-info">
                                                        <div class="test-name">${test.icon} ${test.name}</div>
                                                        <div class="test-description">${test.tooltip}</div>
                                                        ${notes ? `<div class="test-notes">💭 Notiz: ${notes}</div>` : ''}
                                                    </div>
                                                    <div class="status-badge status-${statusClass}">[${statusText}]</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Seitenumbruch für Abweichungen, Fazit und Anhang -->
                    <div style="page-break-before: always;">
                        ${results.issues.length > 0 ? `
                            <div class="section">
                                <h2>⚠️ Abweichungen und Probleme</h2>
                                <ul class="issues-list">
                                    ${results.issues.map(issue => `
                                        <li class="issue-item">
                                            <div class="issue-type">${issue.type}: ${issue.name}</div>
                                            <p>${issue.description}</p>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <div class="section">
                            <h2>💡 Fazit und Empfehlungen</h2>
                            <p>
                                ${results.failed === 0 ? 
                                    `Das ${categoryToShow} System ist vollständig funktionsfähig. Alle ${results.passed} kritischen Tests wurden erfolgreich bestanden.` :
                                    `Das ${categoryToShow} System weist ${results.failed} kritische Fehler auf. Vor der Freigabe müssen diese Probleme behoben und erneut getestet werden.`
                                }
                            </p>
                            ${results.warning > 0 ? `<p><strong>Empfehlung:</strong> ${results.warning} Verbesserungen sollten für eine optimale Benutzererfahrung umgesetzt werden.</p>` : ''}
                            ${results.ungeprüft > 0 ? `<p><strong>Hinweis:</strong> ${results.ungeprüft} Testpunkte wurden noch nicht geprüft und sollten für eine vollständige Qualitätssicherung nachgeholt werden.</p>` : ''}
                        </div>

                        <div class="section">
                            <h2>📎 Anhang</h2>
                            <p>Detaillierte Testdaten und Screenshots sind im internen AuditLog-System archiviert.</p>
                            <p><strong>Berichts-ID:</strong> AuditLog-${Date.now()}</p>
                            <p><strong>Generiert von:</strong> FavOrg AuditLog-System ${window.auditConfig.version}</p>
                            <p><strong>Testumfang:</strong> ${tests.length} Testpunkte in ${Object.keys(testsByCategory).length} Bereichen</p>
                            <p><strong>Testabdeckung:</strong> ${Math.round((results.passed + results.failed + results.warning) / results.total * 100)}% (${results.passed + results.failed + results.warning}/${results.total} Tests durchgeführt)</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        function resetAll() {
            if (confirm('Alle Tests zurücksetzen?')) {
                window.testStatuses = {};
                window.testNotes = {};
                renderTests();
                updateStatusCounts();
            }
        }

        function goBackToFavOrg() {
            if (window.opener) {
                window.opener.focus();
                window.close();
            } else {
                window.location.href = '/';
            }
        }

        // Config-Dialog Funktionen
        function openConfigDialog() {
            // Lade aktuelle Config in die Formularfelder
            document.getElementById('configTester').value = window.auditConfig.tester;
            document.getElementById('configVersion').value = window.auditConfig.version;
            document.getElementById('configEnvironment').value = window.auditConfig.environment;
            document.getElementById('configTestGoal').value = window.auditConfig.testGoal;
            document.getElementById('configTestMethodology').value = window.auditConfig.testMethodology;
            
            document.getElementById('configDialog').style.display = 'block';
        }

        function closeConfigDialog() {
            document.getElementById('configDialog').style.display = 'none';
        }

        function saveConfigAndClose() {
            // Speichere die Config-Werte
            window.auditConfig.tester = document.getElementById('configTester').value;
            window.auditConfig.version = document.getElementById('configVersion').value;
            window.auditConfig.environment = document.getElementById('configEnvironment').value;
            window.auditConfig.testGoal = document.getElementById('configTestGoal').value;
            window.auditConfig.testMethodology = document.getElementById('configTestMethodology').value;
            
            // Persistiere in LocalStorage
            localStorage.setItem('favorg-audit-config', JSON.stringify(window.auditConfig));
            
            closeConfigDialog();
            alert('Konfiguration erfolgreich gespeichert!');
        }

        // Funktion zum Automatischen Erfassen der Browser-Umgebung
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            let os = 'Unknown OS';
            let browser = 'Unknown Browser';
            
            // Betriebssystem erkennen
            if (userAgent.indexOf('Windows NT 10.0') !== -1) os = 'Windows 10/11';
            else if (userAgent.indexOf('Windows NT 6.3') !== -1) os = 'Windows 8.1';
            else if (userAgent.indexOf('Windows NT 6.1') !== -1) os = 'Windows 7';
            else if (userAgent.indexOf('Mac') !== -1) os = 'macOS';
            else if (userAgent.indexOf('Linux') !== -1) os = 'Linux';
            
            // Browser erkennen
            if (userAgent.indexOf('Chrome') !== -1 && userAgent.indexOf('Edge') === -1) {
                const chromeMatch = userAgent.match(/Chrome\/(\d+)/);
                browser = 'Chrome ' + (chromeMatch ? chromeMatch[1] : '');
            } else if (userAgent.indexOf('Firefox') !== -1) {
                const firefoxMatch = userAgent.match(/Firefox\/(\d+)/);
                browser = 'Firefox ' + (firefoxMatch ? firefoxMatch[1] : '');
            } else if (userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1) {
                browser = 'Safari';
            } else if (userAgent.indexOf('Edge') !== -1) {
                const edgeMatch = userAgent.match(/Edge\/(\d+)/);
                browser = 'Edge ' + (edgeMatch ? edgeMatch[1] : '');
            }
            
            return os + ', ' + browser;
        }

        // Initialisierung
        function initAuditLog() {
            console.log('🚀 AuditLog Initialisierung gestartet');
            
            try {
                // Auto-Update der Testumgebung bei erstmaliger Nutzung
                if (!localStorage.getItem('favorg-audit-config')) {
                    window.auditConfig.environment = detectEnvironment();
                    localStorage.setItem('favorg-audit-config', JSON.stringify(window.auditConfig));
                }
                
                renderCategories();
                renderTests();
                updateStatusCounts();
                updateArchiveCount();
                
                // Initialisiere Lucide Icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                    console.log('✅ Lucide Icons initialisiert');
                }
                
                console.log('🎉 AuditLog erfolgreich initialisiert');
            } catch (error) {
                console.error('❌ Initialisierungs-Fehler:', error);
            }
        }

        // Mehrfache Initialisierungs-Strategien
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuditLog);
        } else {
            initAuditLog();
        }

        setTimeout(initAuditLog, 500);
        
        console.log('📝 AuditLog Script vollständig geladen');
    </script>
</body>
</html>